<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sayee.sxsy.api.mediate.dao.MediateApiDao">
	<insert id="insert">
		INSERT INTO COMPLAINT_MAIN(
			complaint_main_id,
			case_number,
			patient_name,
			patient_sex,
			patient_age,
			patient_card,
			patient_mobile,
			involve_hospital,
			hospital_level,
			hospital_grade,
			involve_department,
			involve_employee,
			proc_ins_id,
			create_date,
			update_date,
			del_flag,
			source
		) VALUES (
			#{complaintMainId},
			#{caseNumber},
			#{patientName},
			#{patientSex},
			#{patientAge},
			#{patientCard},
			#{patientMobile},
		    #{involveHospital},
		    #{hospitalLevel},
		    #{hospitalGrade},
		    #{involveDepartment},
		    #{involveEmployee},
		    #{procInsid},
		    #{createDate},
			#{updateDate},
		    0,
		    #{source}
		)
	</insert>
	<select id="mediateList" parameterType="java.lang.String" resultType="com.sayee.sxsy.api.mediate.entity.Mediate">
	SELECT (SELECT ACT_HI_ACTINST.act_name_ FROM COMPLAINT_MAIN LEFT JOIN ACT_HI_ACTINST on ACT_HI_ACTINST.proc_inst_id_=COMPLAINT_MAIN.proc_ins_id WHERE complaint_main_id=COMPLAINT_MAIN.complaint_main_id AND ACT_HI_ACTINST.act_type_='userTask' ORDER BY ACT_HI_ACTINST.start_time_ DESC LIMIT 1
) AS actName,COMPLAINT_MAIN.complaint_main_id,COMPLAINT_MAIN.case_number,COMPLAINT_MAIN.create_date,SYS_USER.name,SYS_USER.photo FROM COMPLAINT_MAIN_DETAIL LEFT JOIN COMPLAINT_MAIN ON COMPLAINT_MAIN.complaint_main_id=COMPLAINT_MAIN_DETAIL.complaint_main_id LEFT JOIN SYS_USER ON SYS_USER.id=COMPLAINT_MAIN_DETAIL.next_link_man LEFT JOIN CMS_WECHATUSER ON CMS_WECHATUSER.sys_user_id=SYS_USER.id WHERE CMS_WECHATUSER.wechat_user_id=#{wechatUserId}
	</select>
	<select id="mediateListForHos" parameterType="java.lang.String" resultType="com.sayee.sxsy.api.mediate.entity.Mediate">SELECT (SELECT ACT_HI_ACTINST.act_name_ FROM COMPLAINT_MAIN LEFT JOIN ACT_HI_ACTINST on ACT_HI_ACTINST.proc_inst_id_=COMPLAINT_MAIN.proc_ins_id WHERE complaint_main_id=COMPLAINT_MAIN.complaint_main_id AND ACT_HI_ACTINST.act_type_='userTask' ORDER BY ACT_HI_ACTINST.start_time_ DESC LIMIT 1
) AS actName,COMPLAINT_MAIN.complaint_main_id,COMPLAINT_MAIN.case_number,COMPLAINT_MAIN.create_date,SYS_USER.name,SYS_USER.photo FROM COMPLAINT_MAIN_DETAIL LEFT JOIN COMPLAINT_MAIN ON COMPLAINT_MAIN.complaint_main_id=COMPLAINT_MAIN_DETAIL.complaint_main_id LEFT JOIN SYS_USER ON SYS_USER.id=COMPLAINT_MAIN_DETAIL.next_link_man LEFT JOIN CMS_WECHATUSER ON CMS_WECHATUSER.sys_user_id=SYS_USER.id WHERE COMPLAINT_MAIN.involve_hospital= (select sys_user.office_id from sys_user left join cms_wechatuser on cms_wechatuser.sys_user_id=sys_user.id where cms_wechatuser.wechat_user_id=#{wechatUserId})
	</select>
	<select id="findMediateById" parameterType="java.lang.String" resultType="com.sayee.sxsy.api.mediate.entity.MediateCommon">
		SELECT COMPLAINT_MAIN.patient_sex AS patientSex,COMPLAINT_MAIN.patient_age AS patientAge,COMPLAINT_MAIN.involve_hospital AS involveHospital,COMPLAINT_MAIN.case_number AS caseNumber,COMPLAINT_INFO.visitor_date AS visitorDate,COMPLAINT_INFO.complaint_mode AS complaintMode,COMPLAINT_INFO.visitor_name AS visitorName,COMPLAINT_INFO.visitor_mobile AS visitorMobile,COMPLAINT_INFO.visitor_number AS visitorNumber,COMPLAINT_INFO.patient_relation AS patientRelation,COMPLAINT_INFO.summary_of_disputes AS summaryOfDisputes,COMPLAINT_INFO.appeal,COMPLAINT_INFO.reception_employee AS receptionEmployee,COMPLAINT_INFO.reception_date AS receptionDate,COMPLAINT_INFO.next_link_man AS nextLinkMan,COMPLAINT_INFO.patient_name AS patientName,COMPLAINT_INFO.status FROM COMPLAINT_MAIN LEFT JOIN COMPLAINT_INFO ON COMPLAINT_INFO.complaint_main_id=COMPLAINT_MAIN.complaint_main_id WHERE COMPLAINT_MAIN.complaint_main_id=#{complaintMainId}
	</select>
	<select id="getCaseNumber" parameterType="java.lang.String" resultType="java.lang.String">
		SELECT MAX(case_number) FROM COMPLAINT_MAIN WHERE del_flag=0 AND case_number LIKE CONCAT('%',#{nowDate},'%')
	</select>
	<update id="setProInstId" parameterType="java.util.Map">
		UPDATE COMPLAINT_MAIN set proc_ins_id=#{procInsId} WHERE COMPLAINT_MAIN_ID=#{complaintMainId}
	</update>
	<select id="getStatus" parameterType="java.lang.String" resultType="java.lang.String">
		SELECT ACT_HI_ACTINST.act_name_ FROM COMPLAINT_MAIN LEFT JOIN act_hi_actinst on ACT_HI_ACTINST.proc_inst_id_=COMPLAINT_MAIN.proc_ins_id WHERE COMPLAINT_MAIN_ID='594f5754e4754133aa94caf67980c2a9' AND ACT_HI_ACTINST.act_type_='userTask' ORDER BY ACT_HI_ACTINST.start_time_ DESC LIMIT 1
	</select>
	<select id="getMediateInfo" parameterType="java.lang.String" resultType="com.sayee.sxsy.api.mediate.entity.MediateCommon">
	SELECT COMPLAINT_MAIN.patient_name AS patientName,COMPLAINT_MAIN.case_number AS caseNumber,COMPLAINT_MAIN_DETAIL.visitor_name AS visitorName,COMPLAINT_MAIN_DETAIL.patient_relation AS patientRelation,COMPLAINT_MAIN_DETAIL.visitor_mobile AS visitorMobile,COMPLAINT_MAIN_DETAIL.summary_of_disputes AS summaryOfDisputes,COMPLAINT_MAIN_DETAIL.appeal,SYS_OFFICE.name as involveHospital FROM COMPLAINT_MAIN left join COMPLAINT_MAIN_DETAIL on COMPLAINT_MAIN.complaint_main_id=COMPLAINT_MAIN_DETAIL.complaint_main_id left join SYS_OFFICE on COMPLAINT_MAIN.involve_hospital=SYS_OFFICE.id WHERE COMPLAINT_MAIN.complaint_main_id=#{complaintMainId}
	</select>
	<select id="getActInfo" parameterType="java.lang.String" resultType="com.sayee.sxsy.api.mediate.entity.ActInst">
		SELECT ACT_HI_ACTINST.act_name_ AS actName,ACT_HI_ACTINST.start_time_ AS startTime FROM ACT_HI_ACTINST LEFT JOIN COMPLAINT_MAIN ON COMPLAINT_MAIN.proc_ins_id=ACT_HI_ACTINST.proc_inst_id_ WHERE COMPLAINT_MAIN.complaint_main_id=#{complaintMainId} AND ACT_HI_ACTINST.act_type_='userTask'
	</select>
</mapper>
